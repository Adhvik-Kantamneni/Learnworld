<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LearnWorld ğŸŒ</title>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;600;700;800&family=Boogaloo&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Baloo 2',cursive;background:#FFF9F0;color:#2D3436;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(circle at 10% 20%,rgba(255,107,107,.06) 0%,transparent 40%),radial-gradient(circle at 90% 80%,rgba(78,205,196,.06) 0%,transparent 40%);pointer-events:none;z-index:0;}

/* â”€â”€ HEADER â”€â”€ */
header{position:sticky;top:0;z-index:100;background:white;padding:12px 22px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 20px rgba(0,0,0,.07);}
.logo{font-family:'Boogaloo',cursive;font-size:1.75rem;background:linear-gradient(135deg,#FF6B6B,#4ECDC4,#45B7D1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.stars-badge{display:flex;align-items:center;gap:7px;background:linear-gradient(135deg,#FFD700,#FFA500);color:white;padding:7px 15px;border-radius:50px;font-weight:800;font-size:1rem;box-shadow:0 4px 15px rgba(255,165,0,.3);}
.hdr-right{display:flex;align-items:center;gap:9px;}
.hdr-btn{background:white;border:2.5px solid #e9ecef;border-radius:50px;padding:7px 15px;font-family:'Baloo 2',cursive;font-weight:800;font-size:.85rem;cursor:pointer;color:#2D3436;transition:border-color .2s;}
.hdr-btn:hover{border-color:#4ECDC4;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;position:relative;z-index:1;animation:fadeUp .4s ease both;}
.screen.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes bigPop{from{opacity:0;transform:scale(.6);}to{opacity:1;transform:scale(1);}}
@keyframes cfall{to{transform:translateY(110vh) rotate(720deg);opacity:0;}}
@keyframes pulse{0%,100%{box-shadow:0 0 0 4px rgba(78,205,196,.3);}50%{box-shadow:0 0 0 10px rgba(78,205,196,.08);}}

/* â”€â”€ CARDS / BTNS â”€â”€ */
.card{background:white;border-radius:20px;padding:26px;box-shadow:0 8px 32px rgba(0,0,0,.09);}
.big-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--c),var(--cd));color:white;border:none;border-radius:13px;font-family:'Boogaloo',cursive;font-size:1.2rem;cursor:pointer;box-shadow:0 6px 20px rgba(0,0,0,.13);transition:transform .15s;}
.big-btn:hover{transform:translateY(-2px);}
.out-btn{background:white;color:#2D3436;border:3px solid #e9ecef;border-radius:50px;padding:12px 26px;font-family:'Boogaloo',cursive;font-size:1rem;cursor:pointer;transition:border-color .2s;}
.out-btn:hover{border-color:#4ECDC4;}
.opt-btn{background:#f8f9fa;border:3px solid #e9ecef;border-radius:13px;padding:13px 15px;font-family:'Baloo 2',cursive;font-size:.9rem;font-weight:700;cursor:pointer;color:#2D3436;text-align:left;display:flex;align-items:center;gap:9px;line-height:1.4;width:100%;transition:all .15s;}
.opt-btn:hover:not(:disabled){background:#e0faf7;border-color:#4ECDC4;}
.opt-btn.correct{background:#00b894!important;border-color:#00b894!important;color:white!important;}
.opt-btn.wrong{background:#ff7675!important;border-color:#ff7675!important;color:white!important;}
.opt-letter{width:24px;height:24px;border-radius:50%;background:white;color:#2D3436;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.74rem;flex-shrink:0;}
.correct .opt-letter,.wrong .opt-letter{background:rgba(255,255,255,.3);color:white;}
.spinner{width:46px;height:46px;border:5px solid #e9ecef;border-top-color:var(--accent,#4ECDC4);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 14px;}
.feedback{border-radius:12px;padding:12px 17px;font-weight:700;font-size:.9rem;margin-bottom:13px;display:flex;align-items:flex-start;gap:9px;line-height:1.5;}
.feedback.ok{background:#d4edda;color:#155724;}
.feedback.bad{background:#f8d7da;color:#721c24;}

/* â”€â”€ OVERLAY â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:1000;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.overlay-card{background:white;border-radius:28px;padding:44px 38px;text-align:center;max-width:420px;width:90%;box-shadow:0 24px 80px rgba(0,0,0,.25);animation:bigPop .5s cubic-bezier(.34,1.56,.64,1) both;}



/* â”€â”€ SETUP â”€â”€ */
#setup-screen{padding:46px 22px;max-width:500px;margin:0 auto;text-align:center;}
.setup-card{background:white;border-radius:28px;padding:40px 34px;box-shadow:0 8px 32px rgba(0,0,0,.09);}
.field-label{font-weight:800;font-size:.78rem;color:#b2bec3;text-transform:uppercase;letter-spacing:.8px;margin-bottom:7px;text-align:left;}
.name-input{width:100%;padding:13px 17px;border:2.5px solid #e9ecef;border-radius:13px;font-family:'Baloo 2',cursive;font-size:1.05rem;font-weight:700;outline:none;transition:border-color .2s;margin-bottom:22px;}
.name-input:focus{border-color:#4ECDC4;}
.grades-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:26px;}
.grade-btn{background:#f8f9fa;border:2.5px solid #e9ecef;border-radius:12px;padding:11px 6px;cursor:pointer;font-family:'Baloo 2',cursive;font-weight:800;font-size:.84rem;color:#2D3436;transition:all .15s;}
.grade-btn.sel,.grade-btn:hover{background:#e0faf7;border-color:#4ECDC4;color:#4ECDC4;}

/* â”€â”€ HOME â”€â”€ */
#home-screen{padding:26px 22px;max-width:1100px;margin:0 auto;}
.welcome-block{text-align:center;margin-bottom:26px;}
.player-pill{display:inline-flex;align-items:center;gap:9px;background:white;border-radius:50px;padding:8px 18px;box-shadow:0 8px 32px rgba(0,0,0,.09);font-weight:700;margin-bottom:13px;font-size:.88rem;flex-wrap:wrap;justify-content:center;}
.star-pill{background:linear-gradient(135deg,#4ECDC4,#45B7D1);color:white;padding:3px 11px;border-radius:20px;font-size:.78rem;}
.subjects-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:18px;}
.subj-card{background:white;border-radius:20px;padding:24px 20px;cursor:pointer;box-shadow:0 8px 32px rgba(0,0,0,.09);border:3px solid transparent;position:relative;overflow:hidden;transition:transform .2s,box-shadow .2s,border-color .2s;}
.subj-card:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 20px 50px rgba(0,0,0,.13);}
.subj-card.eos-ready{border-color:#FFD700;}
.subj-top-bar{position:absolute;top:0;left:0;right:0;height:5px;border-radius:20px 20px 0 0;}
.subj-icon{font-size:2.8rem;margin-bottom:11px;}
.subj-name{font-family:'Boogaloo',cursive;font-size:1.4rem;margin-bottom:5px;}
.subj-desc{color:#636e72;font-size:.84rem;font-weight:600;line-height:1.5;margin-bottom:10px;}
.mini-bar-wrap{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.mini-bar-track{flex:1;background:#f0f0f0;border-radius:20px;height:7px;overflow:hidden;}
.mini-bar-fill{height:100%;border-radius:20px;transition:width .6s ease;}
.mini-pct{font-size:.74rem;font-weight:700;color:#b2bec3;white-space:nowrap;}
.subj-footer{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;}
.subj-stage-label{font-size:.76rem;font-weight:700;color:#b2bec3;}
.action-btn{border:none;border-radius:20px;padding:5px 13px;font-family:'Boogaloo',cursive;font-size:.82rem;cursor:pointer;transition:transform .15s;}
.action-btn:hover{transform:scale(1.05);}

/* â”€â”€ QUIZ / EOS / PRACTICE â”€â”€ */
#quiz-screen,#eos-screen,#practice-screen{padding:22px;max-width:740px;margin:0 auto;}
.quiz-title-row{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
.quiz-title{font-family:'Boogaloo',cursive;font-size:1.55rem;}
.quiz-q-num{margin-left:auto;font-size:.8rem;font-weight:700;color:#b2bec3;}
.stage-bar-wrap{background:white;border-radius:13px;padding:11px 15px;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:17px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.stage-bar-label{font-size:.74rem;font-weight:700;color:#b2bec3;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
.stage-bar-track{flex:1;background:#f0f0f0;border-radius:20px;height:9px;overflow:hidden;min-width:80px;}
.stage-bar-fill{height:100%;border-radius:20px;transition:width .6s ease;}
.stage-q-count{font-size:.78rem;font-weight:700;color:#b2bec3;white-space:nowrap;}
.eos-badge{background:linear-gradient(135deg,#FFD700,#FFA500);color:white;border-radius:20px;padding:3px 10px;font-size:.76rem;font-weight:800;white-space:nowrap;}
.streak-badge{border-radius:20px;padding:3px 10px;font-size:.76rem;font-weight:800;}
.q-card{background:white;border-radius:20px;padding:28px;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:14px;border-top:6px solid var(--accent,#4ECDC4);}
.q-label{font-size:.74rem;font-weight:700;color:#b2bec3;text-transform:uppercase;letter-spacing:1px;margin-bottom:7px;}
.q-text{font-size:clamp(1rem,2.5vw,1.28rem);font-weight:800;line-height:1.55;margin-bottom:22px;}
.opts-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:480px){.opts-grid{grid-template-columns:1fr;}}
.loading-card{background:white;border-radius:20px;padding:44px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:14px;}
.exam-warn{background:linear-gradient(135deg,#fff3cd,#fff);border:2px solid #FFD700;border-radius:13px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.exam-warn-text{font-weight:700;color:#856404;font-size:.88rem;}

/* â”€â”€ RESULTS â”€â”€ */
#results-screen{padding:32px 22px;max-width:520px;margin:0 auto;text-align:center;}
.results-card{background:white;border-radius:28px;padding:38px 30px;box-shadow:0 8px 32px rgba(0,0,0,.09);}
.results-emoji{font-size:4rem;margin-bottom:10px;}
.results-title{font-family:'Boogaloo',cursive;font-size:2.1rem;margin-bottom:7px;}
.results-score{font-size:3rem;font-weight:900;margin:14px 0;line-height:1;}
.results-score span{font-size:1.2rem;color:#b2bec3;}
.results-stars{font-size:1.8rem;margin:7px 0 9px;}
.results-msg{color:#636e72;font-weight:600;font-size:.9rem;margin-bottom:6px;}
.badge-pill{padding:9px 16px;border-radius:12px;font-weight:700;font-size:.86rem;margin:7px auto 14px;display:inline-block;}
.badge-green{background:#d4edda;color:#155724;}
.badge-red{background:#f8d7da;color:#721c24;}
.badge-grey{background:#e9ecef;color:#636e72;}
.results-btns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px;}

/* â”€â”€ PROGRESS â”€â”€ */
#progress-screen{padding:24px 22px;max-width:900px;margin:0 auto;}
.pg-title{font-family:'Boogaloo',cursive;font-size:1.7rem;margin-bottom:18px;}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:11px;margin-bottom:20px;}
.stat-card{background:white;border-radius:18px;padding:16px 12px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.09);}
.stat-num{font-family:'Boogaloo',cursive;font-size:2rem;line-height:1;margin-bottom:3px;}
.stat-lbl{font-size:.72rem;font-weight:700;color:#b2bec3;text-transform:uppercase;letter-spacing:.5px;}
.section-heading{font-family:'Boogaloo',cursive;font-size:1.15rem;margin-bottom:9px;}
.stage-journey-wrap{background:white;border-radius:18px;padding:16px;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:18px;}
.stage-pips{display:flex;flex-wrap:wrap;gap:4px;}
.pip{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.58rem;font-weight:900;cursor:default;}
.pip.done{background:#4ECDC4;color:white;}
.pip.curr{background:#4ECDC4;color:white;animation:pulse 1.5s infinite;}
.pip.locked{background:#e9ecef;color:#b2bec3;}
.subj-row{background:white;border-radius:14px;padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:8px;display:flex;align-items:center;gap:11px;flex-wrap:wrap;}
.subj-row-icon{font-size:1.4rem;}
.subj-row-name{font-weight:800;min-width:80px;font-size:.9rem;}
.subj-bars{display:flex;flex-direction:column;gap:3px;flex:1;min-width:100px;}
.subj-bar-row{display:flex;align-items:center;gap:5px;}
.subj-bar-lbl{font-size:.66rem;color:#b2bec3;font-weight:700;min-width:45px;}
.subj-bar-track{flex:1;background:#f0f0f0;border-radius:20px;height:5px;overflow:hidden;}
.subj-bar-fill{height:100%;border-radius:20px;transition:width .8s ease;}
.subj-bar-val{font-family:'Boogaloo',cursive;font-size:.85rem;min-width:36px;text-align:right;}
.subj-q-total{font-size:.72rem;color:#b2bec3;font-weight:700;}
.eos-tag{font-size:.72rem;font-weight:800;color:#E17055;}
.weak-card{background:white;border-radius:16px;padding:14px 17px;box-shadow:0 8px 32px rgba(0,0,0,.09);margin-bottom:9px;border-left:5px solid #ff7675;}
.weak-subj{font-family:'Boogaloo',cursive;color:#d63031;margin-bottom:3px;font-size:1rem;}
.weak-q{font-size:.84rem;color:#636e72;font-weight:600;margin-bottom:7px;line-height:1.4;}
.weak-bar-row{display:flex;align-items:center;gap:9px;}
.weak-bar-track{flex:1;background:#f8f9fa;border-radius:20px;height:7px;overflow:hidden;}
.weak-bar-fill{height:100%;border-radius:20px;background:linear-gradient(90deg,#ff7675,#fd79a8);}
.weak-pct{font-size:.8rem;font-weight:700;color:#d63031;}
.practice-cta{border:none;border-radius:15px;padding:18px 26px;width:100%;cursor:pointer;font-family:'Boogaloo',cursive;font-size:1.2rem;display:flex;align-items:center;justify-content:center;gap:9px;margin-top:18px;transition:transform .15s;}
.practice-cta.active{background:linear-gradient(135deg,#E17055,#d63031);color:white;box-shadow:0 8px 24px rgba(214,48,49,.25);}
.practice-cta.active:hover{transform:translateY(-3px);}
.practice-cta.inactive{background:#e9ecef;color:#b2bec3;cursor:default;}
.empty-msg{text-align:center;padding:38px 20px;color:#b2bec3;font-weight:700;}

</style>
</head>
<body>

<header>
  <div class="logo">ğŸŒ LearnWorld</div>
  <div class="hdr-right">
    <button class="hdr-btn" id="progressHdrBtn" style="display:none" onclick="showScreen('progress')">ğŸ“Š Progress</button>
    <button class="hdr-btn" id="homeHdrBtn" style="display:none" onclick="showScreen('home')">ğŸ  Home</button>
    <div class="stars-badge">â­ <span id="starsDisplay">0</span></div>
  </div>
</header>

<!-- STAGE UP OVERLAY -->
<div class="overlay" id="stageUpOverlay">
  <div class="overlay-card">
    <div style="font-size:4.5rem;margin-bottom:10px">ğŸ‰</div>
    <div style="font-family:'Boogaloo',cursive;font-size:1.9rem;margin-bottom:5px" id="stageUpTitle">Stage Complete!</div>
    <div style="color:#636e72;font-weight:600;margin-bottom:6px">You've reached</div>
    <div style="font-family:'Boogaloo',cursive;font-size:3.5rem;line-height:1;margin-bottom:5px" id="stageUpNum">Stage 2</div>
    <div style="color:#636e72;font-weight:600;margin-bottom:22px;font-size:.95rem" id="stageUpDesc"></div>
    <button class="big-btn" style="--c:#4ECDC4;--cd:#39b2a8;width:auto;padding:13px 34px;border-radius:50px" onclick="closeStageUp()">Keep Going! â†’</button>
  </div>
</div>

<!-- GRADE UP OVERLAY -->
<div class="overlay" id="gradeUpOverlay">
  <div class="overlay-card">
    <div style="font-size:5rem;margin-bottom:10px">ğŸ“</div>
    <div style="font-family:'Boogaloo',cursive;font-size:2rem;color:#4ECDC4;margin-bottom:6px">Grade Advance!</div>
    <div style="color:#636e72;font-weight:600;margin-bottom:8px">You've completed all 50 stages!</div>
    <div style="font-family:'Boogaloo',cursive;font-size:1.7rem;color:#2D3436;margin-bottom:22px" id="gradeUpName"></div>
    <button class="big-btn" style="--c:#4ECDC4;--cd:#39b2a8;width:auto;padding:13px 34px;border-radius:50px" onclick="closeGradeUp()">Start New Grade! ğŸš€</button>
  </div>
</div>

    </div>
    </div>
  </div>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen" class="screen active">
  <div class="setup-card">
    <div style="font-size:3rem;margin-bottom:10px">ğŸ‘‹</div>
    <div style="font-family:'Boogaloo',cursive;font-size:1.9rem;margin-bottom:7px">Welcome to LearnWorld!</div>
    <p style="color:#636e72;font-weight:600;margin-bottom:26px;font-size:.95rem">Tell us about yourself and we'll set the perfect starting stage!</p>
    <div class="field-label">Your Name</div>
    <input class="name-input" id="nameInput" placeholder="Enter your name..." maxlength="20"/>
    <div class="field-label">Your Grade</div>
    <div class="grades-grid" id="gradesGrid"></div>
    <button class="big-btn" style="--c:#4ECDC4;--cd:#39b2a8" onclick="confirmSetup()">Start Learning! ğŸš€</button>
  </div>
</div>

<!-- HOME SCREEN -->
<div id="home-screen" class="screen">
  <div class="welcome-block">
    <div class="player-pill" id="playerPill"></div>
    <div style="font-family:'Boogaloo',cursive;font-size:clamp(1.5rem,4vw,2.6rem);margin-bottom:5px">What do you want to learn? ğŸ‰</div>
    <div style="color:#636e72;font-weight:600;font-size:.9rem">Complete 300 correct answers per stage, then take the End-of-Stage Exam!</div>
  </div>
  <div class="subjects-grid" id="subjectsGrid"></div>
</div>

<!-- QUIZ SCREEN -->
<div id="quiz-screen" class="screen">
  <div class="quiz-title-row">
    <div class="quiz-title" id="quizTitle"></div>
    <div class="quiz-q-num" id="quizQNum"></div>
  </div>
  <div class="stage-bar-wrap" id="stageBarWrap"></div>
  <div id="questionArea"></div>
  <div class="feedback" id="quizFeedback" style="display:none"></div>
  <button class="big-btn" id="quizNextBtn" style="display:none" onclick="quizNext()"></button>
</div>

<!-- EOS SCREEN -->
<div id="eos-screen" class="screen">
  <div class="quiz-title-row">
    <div class="quiz-title" style="color:#E17055">ğŸ† End-of-Stage Exam</div>
    <div class="quiz-q-num" id="eosQNum"></div>
  </div>
  <div class="exam-warn" id="eosWarnBar"></div>
  <div id="eosArea"></div>
  <div class="feedback" id="eosFeedback" style="display:none"></div>
  <button class="big-btn" id="eosNextBtn" style="--c:#E17055;--cd:#c0392b;display:none" onclick="eosNext()"></button>
</div>

<!-- RESULTS SCREEN -->
<div id="results-screen" class="screen">
  <div class="results-card">
    <div class="results-emoji" id="rEmoji"></div>
    <div class="results-title" id="rTitle"></div>
    <div class="results-score" id="rScore"></div>
    <div class="results-stars" id="rStars"></div>
    <div class="results-msg" id="rMsg"></div>
    <div id="rBadge"></div>
    <div class="results-btns">
      <button class="big-btn" id="rRetryBtn" style="width:auto;padding:12px 24px;border-radius:50px"></button>
      <button class="out-btn" id="rHomeBtn"></button>
    </div>
  </div>
</div>

<!-- PROGRESS SCREEN -->
<div id="progress-screen" class="screen">
  <div class="pg-title">ğŸ“Š My Progress</div>
  <div class="stats-row" id="statsRow"></div>
  <div id="progressBody"></div>
</div>

<!-- PRACTICE SCREEN -->
<div id="practice-screen" class="screen">
  <div class="quiz-title-row">
    <div class="quiz-title" style="color:#E17055">ğŸ¯ Practice Quiz</div>
    <div class="quiz-q-num" id="practiceQNum"></div>
  </div>
  <div id="practiceArea"></div>
  <div class="feedback" id="practiceFeedback" style="display:none"></div>
  <button class="big-btn" id="practiceNextBtn" style="--c:#E17055;--cd:#c0392b;display:none" onclick="practiceNext()"></button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUBJ_COLORS={math:"#FF6B6B",reading:"#4ECDC4",science:"#45B7D1",geography:"#96CEB4",history:"#E17055",art:"#DDA0DD"};
const SUBJ_ICONS={math:"ğŸ”¢",reading:"ğŸ“š",science:"ğŸ”¬",geography:"ğŸ—ºï¸",history:"ğŸ›ï¸",art:"ğŸ¨"};
const SUBJ_DESC={math:"Numbers, fractions, geometry & algebra",reading:"Vocabulary, grammar & comprehension",science:"Animals, space, body & chemistry",geography:"Countries, capitals & landmarks",history:"Civilizations, wars & famous people",art:"Artists, instruments & music theory"};
const SUBJECTS=Object.keys(SUBJ_ICONS);
const MAX_STAGE=50, QS_PER_STAGE=300, EOS_TOTAL=10, EOS_PASS=0.9;

const GRADES=[
  {label:"Kindergarten"},{label:"Grade 1"},{label:"Grade 2"},
  {label:"Grade 3"},{label:"Grade 4"},{label:"Grade 5"},
  {label:"Grade 6"},{label:"Grade 7"},{label:"Grade 8"},
  {label:"Grade 9"},{label:"Grade 10"},{label:"Grade 11"},
  {label:"Grade 12"},{label:"College/Adult"},{label:"Teacher"},
];

function stageLabel(s){
  if(s<=5)return"Beginner Basics";if(s<=10)return"Building Foundations";
  if(s<=15)return"Elementary Explorer";if(s<=20)return"Junior Learner";
  if(s<=25)return"Intermediate Thinker";if(s<=30)return"Middle School Ready";
  if(s<=35)return"Advanced Student";if(s<=40)return"High School Level";
  if(s<=45)return"Pre-Expert";if(s<=48)return"Expert Scholar";return"Master Level ğŸ“";
}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function qs(id){return document.getElementById(id);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeState(gi=5){
  const stages={},streaks={},stageQC={},stageCC={};
  SUBJECTS.forEach(s=>{stages[s]=1;streaks[s]=0;stageQC[s]=0;stageCC[s]=0;});
  return{playerName:"",gradeIndex:gi,stages,streaks,stageQCounts:stageQC,stageCorrects:stageCC,
    totalStars:0,totalAnswered:0,totalCorrect:0,
    subjectStats:{math:{c:0,t:0},reading:{c:0,t:0},science:{c:0,t:0},geography:{c:0,t:0},history:{c:0,t:0},art:{c:0,t:0}},
    weakTopics:{},askedSet:[]};
}

let ST=makeState();
function save(){try{localStorage.setItem("lw_v6",JSON.stringify(ST));}catch(e){}}
function load(){try{const r=localStorage.getItem("lw_v6");if(r){ST=JSON.parse(r);return true;}}catch(e){}return false;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  qs(id+'-screen').classList.add('active');
  const loggedIn=ST.playerName;
  qs('progressHdrBtn').style.display=loggedIn?'block':'none';
  qs('homeHdrBtn').style.display=loggedIn&&id!=='home'?'block':'none';
  qs('starsDisplay').textContent=ST.totalStars;
  document.documentElement.style.setProperty('--accent',currentAccent||'#4ECDC4');
}

let currentAccent='#4ECDC4';
function setAccent(c){currentAccent=c;document.documentElement.style.setProperty('--accent',c);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function buildGrades(){
  const g=qs('gradesGrid');
  GRADES.forEach((gr,i)=>{
    const b=document.createElement('button');
    b.className='grade-btn'+(i===5?' sel':'');
    b.textContent=gr.label;
    b.dataset.i=i;
    b.onclick=()=>{document.querySelectorAll('.grade-btn').forEach(x=>x.classList.remove('sel'));b.classList.add('sel');};
    g.appendChild(b);
  });
})();

function confirmSetup(){
  const name=qs('nameInput').value.trim()||'Learner';
  const gi=parseInt(document.querySelector('.grade-btn.sel').dataset.i);
  ST={...makeState(gi),playerName:name,gradeIndex:gi};
  save();
  initHome();
  showScreen('home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initHome(){
  qs('playerPill').innerHTML=`ğŸ‘¤ ${ST.playerName} &nbsp;Â·&nbsp; ${GRADES[ST.gradeIndex].label} <span class="star-pill">â­ ${ST.totalStars} Stars</span>`;
  const grid=qs('subjectsGrid');
  grid.innerHTML='';
  SUBJECTS.forEach(s=>{
    const unlocked=isEosUnlocked(s);
    const qDone=stageQC(s);
    const pct=Math.min(100,Math.round((qDone/QS_PER_STAGE)*100));
    const c=SUBJ_COLORS[s];
    const card=document.createElement('div');
    card.className='subj-card'+(unlocked?' eos-ready':'');
    card.innerHTML=`
      <div class="subj-top-bar" style="background:${c}"></div>
      <div class="subj-icon">${SUBJ_ICONS[s]}</div>
      <div class="subj-name" style="color:${c}">${cap(s)}</div>
      <div class="subj-desc">${SUBJ_DESC[s]}</div>
      <div class="mini-bar-wrap">
        <div class="mini-bar-track"><div class="mini-bar-fill" style="background:${c};width:${pct}%"></div></div>
        <span class="mini-pct">${pct}%</span>
      </div>
      <div class="subj-footer">
        <span class="subj-stage-label">Stage ${ST.stages[s]} Â· ${qDone}/${QS_PER_STAGE}Q</span>
        ${unlocked
          ? `<button class="action-btn" style="background:linear-gradient(135deg,#FFD700,#FFA500);color:white" onclick="event.stopPropagation();startEOS('${s}')">ğŸ† Take Exam!</button>`
          : `<button class="action-btn" style="background:${c}22;color:${c}" onclick="event.stopPropagation();startQuiz('${s}')">â–¶ Practice</button>`}
      </div>`;
    grid.appendChild(card);
  });
}

function stageQC(subj){return ST.stageQCounts?.[subj]||0;}
function isEosUnlocked(subj){return stageQC(subj)>=QS_PER_STAGE&&ST.stages[subj]<MAX_STAGE;}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(prompt){
  const res=await fetch("https://api.anthropic.com/v1/messages",{
    method:"POST",headers:{"Content-Type":"application/json","anthropic-dangerous-direct-browser-access":"true"},
    body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:800,messages:[{role:"user",content:prompt}]})
  });
  const d=await res.json();
  return JSON.parse(d.content.map(b=>b.text||"").join("").replace(/```json|```/g,"").trim());
}

function buildPrompt(subj,stage,gradeName,asked,isEOS=false){
  const eosNote=isEOS?"This is an END-OF-STAGE EXAM â€” be thorough and representative of Stage "+stage+" for "+gradeName+".":"";
  return `You are a quiz generator for a kids learning app.
Generate ONE multiple choice question.
Subject: ${cap(subj)}
Student grade level: ${gradeName}
Stage within this grade: ${stage} of 50
${eosNote}
Difficulty: The grade sets the BASE level. Stage 1 = introductory for this grade, Stage 50 = hardest for this grade.
Stage 1 Kindergarten = very basic shapes/letters. Stage 1 Grade 12 = intro high school. Stage 50 Grade 12 = extremely challenging.
Do NOT repeat: ${asked.slice(-40).join(" | ")||"none"}
4 options, exactly one correct, plausible wrong answers, short friendly explanation.
Reply ONLY with JSON: {"question":"...","options":["...","...","...","..."],"answer":0,"explanation":"..."}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let quizSubj=null,quizQ=null,quizCount=0,quizScore=0,quizAnswered=false,quizStageStart=1;
let prefetch=null,stageUpPending=false;

async function startQuiz(subj){
  quizSubj=subj;quizCount=0;quizScore=0;quizAnswered=false;quizStageStart=ST.stages[subj];prefetch=null;
  setAccent(SUBJ_COLORS[subj]);
  qs('quizTitle').textContent=SUBJ_ICONS[subj]+' '+cap(subj);
  qs('quizFeedback').style.display='none';
  qs('quizNextBtn').style.display='none';
  renderStageBar(subj);
  showScreen('quiz');
  await loadQ();
  prefetch=fetchQ(quizSubj);
}

function renderStageBar(subj){
  const stage=ST.stages[subj],qDone=stageQC(subj),pct=Math.min(100,(qDone/QS_PER_STAGE)*100);
  const c=SUBJ_COLORS[subj],unlocked=isEosUnlocked(subj);
  qs('stageBarWrap').innerHTML=`
    <span class="stage-bar-label">Stage ${stage}</span>
    <div class="stage-bar-track"><div class="stage-bar-fill" style="background:linear-gradient(90deg,${c},${c}88);width:${pct}%"></div></div>
    <span class="stage-q-count">${qDone}/${QS_PER_STAGE}Q</span>
    ${unlocked?'<span class="eos-badge">ğŸ† Exam Ready!</span>':(ST.streaks[subj]>0?`<span class="streak-badge" style="background:${c}22;color:${c}">ğŸ”¥ ${ST.streaks[subj]}</span>`:'')}`;
}

function fetchQ(subj,isEOS=false){
  return callClaude(buildPrompt(subj,ST.stages[subj],GRADES[ST.gradeIndex].label,ST.askedSet,isEOS));
}

async function loadQ(){
  quizAnswered=false;
  qs('quizFeedback').style.display='none';
  qs('quizNextBtn').style.display='none';
  qs('quizQNum').textContent=`Q ${quizCount+1} of 10`;
  qs('questionArea').innerHTML=`<div class="loading-card"><div class="spinner" style="--accent:${SUBJ_COLORS[quizSubj]}"></div><p style="font-weight:700;color:#636e72">Generating your question...</p></div>`;

  let q=null;
  if(prefetch){try{q=await prefetch;}catch(e){q=null;}prefetch=null;}
  if(!q){try{q=await fetchQ(quizSubj);}catch(e){qs('questionArea').innerHTML='<div class="loading-card"><p style="font-weight:700;color:#d63031">âš ï¸ Connection error. <button onclick="loadQ()" style="border:none;background:none;color:#4ECDC4;font-weight:700;cursor:pointer;font-size:1rem">Try again</button></p></div>';return;}}

  ST.askedSet.push(q.question);if(ST.askedSet.length>200)ST.askedSet.shift();
  quizQ=q;renderQ(q,quizCount+1,'quiz');
  prefetch=fetchQ(quizSubj);
}

function renderQ(q,num,mode){
  const accent=mode==='eos'?'#E17055':mode==='practice'?'#E17055':SUBJ_COLORS[quizSubj]||'#4ECDC4';
  const areaId=mode==='eos'?'eosArea':mode==='practice'?'practiceArea':'questionArea';
  const letters=['A','B','C','D'];
  qs(areaId).innerHTML=`
    <div class="q-card" style="--accent:${accent}">
      <div class="q-label">${mode==='eos'?`Exam Question ${num} of ${EOS_TOTAL}`:mode==='practice'?`Practice Q${num}`:`Question ${num}`}</div>
      <div class="q-text">${q.question}</div>
      <div class="opts-grid">
        ${q.options.map((o,i)=>`<button class="opt-btn" id="${mode}opt${i}" onclick="checkAnswer('${mode}',${i})">
          <span class="opt-letter">${letters[i]}</span>${o}
        </button>`).join('')}
      </div>
    </div>`;
}

function checkAnswer(mode,sel){
  if(mode==='quiz'&&quizAnswered)return;
  if(mode==='eos'&&eosAnswered)return;
  if(mode==='practice'&&practiceAnswered)return;

  const q = mode==='quiz'?quizQ:mode==='eos'?eosQs[eosIdx]:practiceQs[practiceIdx];
  const correct=q.answer,isCorrect=sel===correct;

  // Disable all opts & mark
  for(let i=0;i<4;i++){
    const b=qs(mode+'opt'+i);if(!b)continue;
    b.disabled=true;
    if(i===correct)b.classList.add('correct');
    else if(i===sel)b.classList.add('wrong');
  }

  const fbId=mode==='eos'?'eosFeedback':mode==='practice'?'practiceFeedback':'quizFeedback';
  const fb=qs(fbId);
  fb.className='feedback '+(isCorrect?'ok':'bad');
  fb.innerHTML=isCorrect?`âœ… Correct! ${q.explanation}`:`âŒ Correct answer: <strong>${q.options[correct]}</strong>. ${q.explanation}`;
  fb.style.display='flex';

  if(mode==='quiz') handleQuizAnswer(q,sel,isCorrect);
  else if(mode==='eos') handleEosAnswer(sel,isCorrect);
  else handlePracticeAnswer(q,sel,isCorrect);
}

function handleQuizAnswer(q,sel,isCorrect){
  quizAnswered=true;
  if(isCorrect)quizScore++;

  ST.totalAnswered++;
  if(isCorrect)ST.totalCorrect++;
  ST.subjectStats[quizSubj].t++;
  if(isCorrect)ST.subjectStats[quizSubj].c++;

  const wk=quizSubj+'::'+q.question.slice(0,80);
  if(!ST.weakTopics[wk])ST.weakTopics[wk]={subject:quizSubj,question:q.question,wrong:0,seen:0};
  ST.weakTopics[wk].seen++;
  if(!isCorrect)ST.weakTopics[wk].wrong++;

  // Only correct answers count toward 300
  if(isCorrect){
    ST.stageQCounts[quizSubj]=(ST.stageQCounts[quizSubj]||0)+1;
    ST.stageCorrects[quizSubj]=(ST.stageCorrects[quizSubj]||0)+1;
  }

  if(isCorrect)ST.streaks[quizSubj]++;
  else ST.streaks[quizSubj]=Math.max(0,ST.streaks[quizSubj]-1);

  save();
  renderStageBar(quizSubj);

  const nb=qs('quizNextBtn');
  nb.style.cssText=`--c:${SUBJ_COLORS[quizSubj]};--cd:${SUBJ_COLORS[quizSubj]}bb;display:block`;
  nb.textContent=quizCount+1>=10?'See Results ğŸ‰':'Next Question â†’';
}

function quizNext(){
  const newCount=quizCount+1,newScore=quizScore;
  quizCount=newCount;
  if(newCount>=10)finishQuiz(newScore,newCount);
  else loadQ();
}

function finishQuiz(score,count){
  const pct=score/count;
  const stars=pct===1?3:pct>=0.6?2:1;
  ST.totalStars+=stars;save();
  qs('starsDisplay').textContent=ST.totalStars;
  const rAccent=SUBJ_COLORS[quizSubj];
  setResultsScreen({
    emoji:pct===1?'ğŸ†':pct>=0.8?'ğŸŒŸ':pct>=0.6?'ğŸ˜Š':pct>=0.4?'ğŸ’ª':'ğŸ“–',
    title:pct===1?'Perfect Score!':pct>=0.8?'Excellent!':pct>=0.6?'Good Job!':pct>=0.4?'Keep Going!':'Keep Learning!',
    msg:pct===1?'Every answer correct â€” incredible!':pct>=0.8?'Brilliant work!':pct>=0.6?'Nice work! Keep practising!':pct>=0.4?'Good effort!':'Don\'t give up â€” try again!',
    stars,score,count,accent:rAccent,
    badge:ST.stages[quizSubj]>quizStageStart?{text:`ğŸ“ˆ Stage progress building!`,cls:'badge-green'}:{text:`Stage ${ST.stages[quizSubj]} Â· ${stageLabel(ST.stages[quizSubj])}`,cls:'badge-grey'},
    retryLabel:'ğŸ”„ Play Again',retryFn:()=>startQuiz(quizSubj),
    homeFn:()=>{initHome();showScreen('home');}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// END-OF-STAGE EXAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let eosSubj=null,eosQs=[],eosIdx=0,eosScore=0,eosAnswered=false;

async function startEOS(subj){
  eosSubj=subj;eosIdx=0;eosScore=0;eosAnswered=false;eosQs=[];
  setAccent('#E17055');
  qs('eosQNum').textContent='Loadingâ€¦';
  qs('eosFeedback').style.display='none';
  qs('eosNextBtn').style.display='none';
  qs('eosWarnBar').innerHTML=`<span style="font-size:1.2rem">âš ï¸</span><span class="exam-warn-text">You need <strong>90%</strong> (${Math.ceil(EOS_TOTAL*EOS_PASS)}/${EOS_TOTAL}) to pass and advance to Stage ${ST.stages[subj]+1}!</span>`;
  qs('eosArea').innerHTML=`<div class="loading-card"><div class="spinner" style="--accent:#E17055"></div><p style="font-weight:700;color:#636e72">Loading all exam questionsâ€¦</p><p style="font-size:.82rem;color:#b2bec3;font-weight:600;margin-top:5px">Generating all ${EOS_TOTAL} at once so you never wait!</p></div>`;
  showScreen('eos');

  try{
    eosQs=await Promise.all(Array.from({length:EOS_TOTAL},()=>fetchQ(subj,true)));
    renderEosQ();
  }catch(e){
    qs('eosArea').innerHTML=`<div class="loading-card"><p style="font-weight:700;color:#d63031">âš ï¸ Couldn't load exam.</p><button onclick="startEOS('${subj}')" style="margin-top:14px;background:#E17055;color:white;border:none;border-radius:50px;padding:12px 24px;font-family:'Boogaloo',cursive;font-size:1rem;cursor:pointer">Retry</button></div>`;
  }
}

function renderEosQ(){
  eosAnswered=false;
  qs('eosFeedback').style.display='none';
  qs('eosNextBtn').style.display='none';
  qs('eosQNum').textContent=`Q ${eosIdx+1}/${EOS_TOTAL}`;
  const score4=eosScore+(eosAnswered&&eosQs[eosIdx]?1:0);
  qs('eosWarnBar').innerHTML=`<span style="font-size:1.2rem">âš ï¸</span><span class="exam-warn-text">Need <strong>90%</strong> (${Math.ceil(EOS_TOTAL*EOS_PASS)}/${EOS_TOTAL}) to pass!</span>${eosIdx>0?`<span style="margin-left:auto;font-weight:800;color:#856404;font-size:.88rem">${eosScore}/${eosIdx} so far</span>`:''}`;
  renderQ(eosQs[eosIdx],eosIdx+1,'eos');
}

function handleEosAnswer(sel,isCorrect){
  eosAnswered=true;
  if(isCorrect)eosScore++;
  qs('eosNextBtn').style.display='block';
  qs('eosNextBtn').textContent=eosIdx+1>=EOS_TOTAL?'See Exam Results ğŸ‰':'Next Exam Question â†’';
}

function eosNext(){
  if(eosIdx+1>=EOS_TOTAL)finishEOS();
  else{eosIdx++;renderEosQ();}
}

function finishEOS(){
  const pct=eosScore/EOS_TOTAL,passed=pct>=EOS_PASS;
  if(passed){
    const prevStage=ST.stages[eosSubj];
    const newStage=Math.min(prevStage+1,MAX_STAGE);
    ST.stages[eosSubj]=newStage;
    ST.streaks[eosSubj]=0;
    ST.stageQCounts[eosSubj]=0;
    ST.stageCorrects[eosSubj]=0;

    const allMaxed=SUBJECTS.every(s=>ST.stages[s]>=MAX_STAGE);
    if(allMaxed&&ST.gradeIndex<GRADES.length-1){
      ST.gradeIndex++;
      // Reset ALL stages back to 1 for the new grade
      SUBJECTS.forEach(s=>{ST.stages[s]=1;ST.stageQCounts[s]=0;ST.stageCorrects[s]=0;ST.streaks[s]=0;});
      save();
      launchConfetti(180);
      qs('gradeUpName').textContent=GRADES[ST.gradeIndex].label;
      setTimeout(()=>qs('gradeUpOverlay').classList.add('show'),400);
    }else{
      save();
      launchConfetti(130);
      const c=SUBJ_COLORS[eosSubj];
      qs('stageUpTitle').textContent='Stage Complete!';
      qs('stageUpTitle').style.color=c;
      qs('stageUpNum').textContent=`Stage ${newStage}`;
      qs('stageUpNum').style.color=c;
      qs('stageUpDesc').textContent=stageLabel(newStage);
      setTimeout(()=>qs('stageUpOverlay').classList.add('show'),400);
      _afterStageUp=()=>showEosResults(pct,passed);
      return;
    }
  }else{save();}

  showEosResults(pct,passed);
}

let _afterStageUp=null;
function closeStageUp(){qs('stageUpOverlay').classList.remove('show');if(_afterStageUp){const f=_afterStageUp;_afterStageUp=null;f();}}
function closeGradeUp(){qs('gradeUpOverlay').classList.remove('show');initHome();showScreen('home');}

function showEosResults(pct,passed){
  const stars=passed?3:pct>=0.7?2:1;
  ST.totalStars+=stars;save();qs('starsDisplay').textContent=ST.totalStars;
  setResultsScreen({
    emoji:passed?'ğŸ†':'ğŸ’ª',
    title:passed?'Stage Passed!':'Not Quite â€” Try Again!',
    msg:passed?`You scored ${eosScore}/${EOS_TOTAL} (${Math.round(pct*100)}%) â€” advanced to Stage ${ST.stages[eosSubj]}!`:`You scored ${eosScore}/${EOS_TOTAL} (${Math.round(pct*100)}%). Need 90% to pass. Keep practising!`,
    stars,score:eosScore,count:EOS_TOTAL,accent:'#E17055',
    badge:passed?{text:`ğŸ‰ Stage ${ST.stages[eosSubj]} Unlocked!`,cls:'badge-green'}:{text:`âŒ Need ${Math.ceil(EOS_TOTAL*EOS_PASS)}/${EOS_TOTAL} to pass`,cls:'badge-red'},
    retryLabel:'ğŸ”„ Retake Exam',retryFn:()=>startEOS(eosSubj),
    homeFn:()=>{initHome();showScreen('home');}
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRACTICE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let practiceQs=[],practiceIdx=0,practiceScore=0,practiceAnswered=false;

function getWeakTopics(){return Object.values(ST.weakTopics).filter(t=>t.wrong>0).sort((a,b)=>(b.wrong/b.seen)-(a.wrong/a.seen));}

async function startPractice(){
  practiceIdx=0;practiceScore=0;practiceAnswered=false;practiceQs=[];
  setAccent('#E17055');
  qs('practiceQNum').textContent='Loadingâ€¦';
  qs('practiceFeedback').style.display='none';
  qs('practiceNextBtn').style.display='none';
  qs('practiceArea').innerHTML=`<div class="loading-card"><div class="spinner" style="--accent:#E17055"></div><p style="font-weight:700;color:#636e72">Building your personalised practice quizâ€¦</p><p style="font-size:.82rem;color:#b2bec3;font-weight:600;margin-top:5px">Generating all questions at once so you never wait!</p></div>`;
  showScreen('practice');

  const weak=getWeakTopics().slice(0,5);
  const total=Math.max(5,Math.min(10,weak.length*2));
  try{
    practiceQs=await Promise.all(Array.from({length:total},(_,i)=>{
      const w=weak[i%weak.length];
      return callClaude(`A student got this WRONG: "${w.question}"\nGenerate a NEW question on the SAME concept (different wording).\nSubject: ${cap(w.subject)}, Stage: ${ST.stages[w.subject]}/50, Grade: ${GRADES[ST.gradeIndex].label}\nReply ONLY with JSON: {"question":"...","options":["...","...","...","..."],"answer":0,"explanation":"..."}`).then(q=>{q._subject=w.subject;return q;});
    }));
    renderPracticeQ();
  }catch(e){qs('practiceArea').innerHTML='<div class="loading-card"><p style="font-weight:700;color:#d63031">âš ï¸ Couldn\'t load practice quiz.</p></div>';}
}

function renderPracticeQ(){
  practiceAnswered=false;
  qs('practiceFeedback').style.display='none';
  qs('practiceNextBtn').style.display='none';
  const q=practiceQs[practiceIdx];
  qs('practiceQNum').textContent=`Q ${practiceIdx+1}/${practiceQs.length}`;
  // Use renderQ but we need quizSubj set â€” patch it
  const savedSubj=quizSubj;quizSubj=q._subject;
  renderQ(q,practiceIdx+1,'practice');
  quizSubj=savedSubj;
}

function handlePracticeAnswer(q,sel,isCorrect){
  practiceAnswered=true;
  if(isCorrect){
    practiceScore++;
    const wk=q._subject+'::'+q.question.slice(0,80);
    if(ST.weakTopics[wk])ST.weakTopics[wk].wrong=Math.max(0,ST.weakTopics[wk].wrong-1);
    save();
  }
  qs('practiceNextBtn').style.display='block';
  qs('practiceNextBtn').textContent=practiceIdx+1>=practiceQs.length?'See Results ğŸ‰':'Next Practice Question â†’';
}

function practiceNext(){
  if(practiceIdx+1>=practiceQs.length)finishPractice();
  else{practiceIdx++;renderPracticeQ();}
}

function finishPractice(){
  const pct=practiceScore/practiceQs.length;
  const stars=pct>=0.8?3:pct>=0.6?2:1;
  ST.totalStars+=stars;save();qs('starsDisplay').textContent=ST.totalStars;
  setResultsScreen({
    emoji:pct===1?'ğŸ†':pct>=0.8?'ğŸ“ˆ':pct>=0.6?'ğŸ’ª':'ğŸ“–',
    title:pct===1?'Perfect Practice!':pct>=0.8?'Great Progress!':pct>=0.6?'Getting Better!':'Keep Practising!',
    msg:pct===1?'You nailed every weak spot!':pct>=0.8?"You're really improving!":pct>=0.6?'Keep practising!':'Review and try again!',
    stars,score:practiceScore,count:practiceQs.length,accent:'#E17055',
    badge:{text:'ğŸ¯ Practice Complete',cls:'badge-green'},
    retryLabel:'ğŸ”„ Practice Again',retryFn:startPractice,
    homeFn:()=>showScreen('progress')
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setResultsScreen({emoji,title,msg,stars,score,count,accent,badge,retryLabel,retryFn,homeFn}){
  setAccent(accent);
  qs('rEmoji').textContent=emoji;
  qs('rTitle').textContent=title;
  qs('rScore').innerHTML=`<span style="color:${accent}">${score}</span> <span>/ ${count}</span>`;
  qs('rStars').textContent='â­'.repeat(stars)+'â˜†'.repeat(3-stars);
  qs('rMsg').textContent=msg;
  qs('rBadge').innerHTML=badge?`<div class="badge-pill ${badge.cls}">${badge.text}</div>`:'';
  const rb=qs('rRetryBtn');rb.style.cssText=`--c:${accent};--cd:${accent}bb;width:auto;padding:12px 24px;border-radius:50px`;rb.textContent=retryLabel;rb.onclick=retryFn;
  const hb=qs('rHomeBtn');hb.textContent=homeFn===startPractice||retryFn===startPractice?'ğŸ“Š Progress':'ğŸ  Home';hb.onclick=homeFn;
  showScreen('results');
  if(stars>=2)launchConfetti(70);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showProgress(){
  setAccent('#4ECDC4');
  const acc=ST.totalAnswered>0?Math.round((ST.totalCorrect/ST.totalAnswered)*100):0;
  const avgStage=Math.round(SUBJECTS.reduce((a,s)=>a+ST.stages[s],0)/SUBJECTS.length);
  const maxReached=Math.max(...SUBJECTS.map(s=>ST.stages[s]));
  const weak=getWeakTopics();

  qs('statsRow').innerHTML=[['Questions',ST.totalAnswered,'#4ECDC4'],['Accuracy',acc+'%','#00b894'],['Stars',ST.totalStars,'#FFD700'],['Weak Areas',weak.length,'#E17055'],['Avg Stage',avgStage,'#45B7D1']].map(([l,v,c])=>`<div class="stat-card"><div class="stat-num" style="color:${c}">${v}</div><div class="stat-lbl">${l}</div></div>`).join('');

  if(ST.totalAnswered===0){
    qs('progressBody').innerHTML='<div class="empty-msg">ğŸ® Play some quizzes and your progress will appear here!</div>';
    showScreen('progress');return;
  }

  let html='';
  // Stage journey
  html+=`<div class="section-heading">ğŸ—ºï¸ Stage Journey (Highest: Stage ${maxReached})</div>
  <div class="stage-journey-wrap"><div class="stage-pips">
  ${Array.from({length:MAX_STAGE},(_,i)=>{const n=i+1,done=n<maxReached,curr=n===maxReached;return`<div class="pip ${done?'done':curr?'curr':'locked'}" title="Stage ${n}: ${stageLabel(n)}">${done?'âœ“':curr?'â˜…':n}</div>`;}).join('')}
  </div></div>`;

  // Subject rows
  html+=`<div class="section-heading">ğŸ“š Subject Stages & Accuracy</div>`;
  SUBJECTS.forEach(s=>{
    const ss=ST.subjectStats[s],p=ss.t>0?Math.round((ss.c/ss.t)*100):0,c=SUBJ_COLORS[s];
    const qDone=stageQC(s),sPct=Math.min(100,Math.round((qDone/QS_PER_STAGE)*100));
    html+=`<div class="subj-row">
      <span class="subj-row-icon">${SUBJ_ICONS[s]}</span>
      <span class="subj-row-name" style="color:${c}">${cap(s)}</span>
      <div class="subj-bars">
        <div class="subj-bar-row"><span class="subj-bar-lbl">Stage ${ST.stages[s]}</span><div class="subj-bar-track"><div class="subj-bar-fill" style="background:${c};width:${sPct}%"></div></div><span class="subj-bar-val" style="color:#b2bec3;font-size:.68rem">${qDone}/${QS_PER_STAGE}</span></div>
        <div class="subj-bar-row"><span class="subj-bar-lbl">Accuracy</span><div class="subj-bar-track"><div class="subj-bar-fill" style="background:${c};width:${p}%"></div></div><span class="subj-bar-val" style="color:${c}">${p}%</span></div>
      </div>
      <span class="subj-q-total">${ss.t}Q</span>
      ${isEosUnlocked(s)?'<span class="eos-tag">ğŸ† EOS Ready!</span>':''}
    </div>`;
  });

  // Weak areas
  html+=`<div class="section-heading" style="color:#d63031;margin-top:18px">âš ï¸ Areas to Improve</div>`;
  if(weak.length===0){html+=`<div class="card" style="color:#00b894;font-weight:700;text-align:center;padding:16px;margin-bottom:10px">ğŸ‰ No weak areas â€” great work!</div>`;}
  else{weak.slice(0,6).forEach(w=>{const p=Math.round((w.wrong/w.seen)*100);html+=`<div class="weak-card"><div class="weak-subj">${SUBJ_ICONS[w.subject]} ${cap(w.subject)}</div><div class="weak-q">${w.question.length>95?w.question.slice(0,95)+'â€¦':w.question}</div><div class="weak-bar-row"><div class="weak-bar-track"><div class="weak-bar-fill" style="width:${p}%"></div></div><span class="weak-pct">${p}% wrong</span></div></div>`;});}

  // Practice CTA
  const hw=weak.length>0;
  html+=`<button class="practice-cta ${hw?'active':'inactive'}" onclick="${hw?'startPractice()':''}">ğŸ¯ ${hw?'Start Practice Quiz â€” Fix Weak Spots!':'Play more quizzes to unlock practice!'}</button>`;
qs('progressBody').innerHTML=html;
  showScreen('progress');
}

// Override showScreen for progress
const _origShowScreen=window.showScreen;
window.showScreen=function(id){
  if(id==='progress'){showProgress();return;}
  _origShowScreen(id);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function launchConfetti(count=70){
  const cols=["#FF6B6B","#4ECDC4","#45B7D1","#FFD700","#96CEB4","#DDA0DD","#fd79a8"];
  for(let i=0;i<count;i++){
    const el=document.createElement('div'),sz=6+Math.random()*10;
    Object.assign(el.style,{position:'fixed',top:'-12px',left:`${Math.random()*100}vw`,width:`${sz}px`,height:`${sz}px`,background:cols[Math.floor(Math.random()*cols.length)],borderRadius:Math.random()>.5?'50%':'3px',zIndex:9999,pointerEvents:'none',animation:`cfall ${1.5+Math.random()*2.5}s linear ${Math.random()*.7}s forwards`});
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),4500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function boot(){
  if(load()){
    if(!ST.playerName){showScreen('setup');return;}
    initHome();showScreen('home');
  }
})();
</script>
</body>
</html>
